<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barcode Scanner</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100vw;
        background-color: #f4f4f9;
      }
      #scanner {
        width: 100%;
        height: 50%;
        max-width: 600px;
        margin: 20px 0;
      }
      textarea {
        width: 100%;
        max-width: 600px;
        height: 200px;
      }
    </style>
  </head>
  <body>
    <h1>Barcode Scanner 0.3</h1>
    <div id="scanner"></div>
    <textarea
      id="barcode-results"
      readonly
      placeholder="Scanned barcodes will appear here..."
    ></textarea>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
      const resultsTextArea = document.getElementById("barcode-results");
      const scannedBarcodes = new Set(); // Set to track added barcodes

      function addBarcode(barcode) {
        // Regex: Start with 4 letters, followed by alphanumeric characters only
        const isValid = /^[A-Za-z]{4}[A-Za-z0-9]+$/.test(barcode);

        if (!isValid) {
          console.log("Invalid barcode format:", barcode);
          return; // Skip invalid barcodes
        }

        if (!scannedBarcodes.has(barcode)) {
          scannedBarcodes.add(barcode); // Add the barcode to the Set
          resultsTextArea.value += barcode + "\n"; // Append to the textarea
        } else {
          console.log("Barcode already added:", barcode);
        }
      }

      Quagga.init(
        {
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector("#scanner"),
            constraints: {
              facingMode: { ideal: "environment" },
            },
          },
          decoder: {
            readers: [
              "code_128_reader", // Common for shipping
              "code_39_reader", // Common in logistics
            ],
          },
        },
        function (err) {
          if (err) {
            console.error("QuaggaJS Initialization Error:", err);
            alert("Error initializing camera");
            return;
          }
          Quagga.start();
        },
      );

      Quagga.onDetected(function (data) {
        const barcode = data.codeResult.code;
        addBarcode(barcode); // Validate and add the barcode
      });
    </script>
  </body>
</html>
